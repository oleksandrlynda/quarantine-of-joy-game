<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quarantine of Joy â€” Weather Test</title>
  <link rel="stylesheet" href="styles/styles.css" />
  <style>
    body{ margin:0; overflow:hidden; }
    #toolbar{ position:fixed; left:8px; top:8px; z-index:10; display:flex; align-items:center; gap:8px; background:#ffffffcc; border-radius:12px; padding:6px 10px; box-shadow:0 8px 24px #00000022; font:12px/1.2 system-ui,sans-serif }
  </style>
  <link rel="icon" href="assets/icons/favicon.svg" type="image/svg+xml" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="robots" content="noindex, nofollow" />
  <meta http-equiv="Cache-Control" content="no-store" />
</head>
<body>
  <div id="toolbar">
    <span>Biome:</span>
    <select id="biomeSel">
      <option value="grass">Grass</option>
      <option value="desert">Desert</option>
      <option value="urban">Urban</option>
    </select>
    <span>Weather:</span>
    <select id="weatherSel">
      <option value="clear">Clear</option>
      <option value="rain">Rain</option>
      <option value="rain+fog">Rain + Fog</option>
      <option value="snow">Snow</option>
      <option value="fog">Fog</option>
      <option value="sandstorm">Sandstorm</option>
      <option value="windy">Windy</option>
    </select>
  </div>
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.159.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js?module';
    import { createWorld } from './src/world.js';
    import { WeatherSystem } from './src/weather.js';
    import { BiomeManager } from './src/biome.js';
    import { SFX } from './src/sfx.js';

    const { renderer, scene, camera, skyMat, hemi, dir, mats, grassMesh, fauna, ambient, updateDayNight } = createWorld(THREE, Math.random);
    camera.position.set(0, 18, 36);
    camera.lookAt(0, 1.6, 0);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0,1.6,0);
    controls.enableDamping = true;
    controls.enablePan = true;
    controls.dampingFactor = 0.08;
    controls.minDistance = 2;
    controls.maxDistance = 80;

    const weather = new WeatherSystem({ THREE, scene, skyMat, hemi, dir, mats });
    weather._nextChangeAt = Infinity;
    BiomeManager.attachWeather(weather);

    const musicShim = { getContext(){ return new (window.AudioContext||window.webkitAudioContext)(); }, getFxBus(){ return null; } };
    window._SFX = new SFX({ audioContextProvider: ()=>musicShim.getContext(), fxBusProvider: ()=>musicShim.getFxBus() });

    const weatherSel = document.getElementById('weatherSel');
    const applyWeather = ()=> weather.setMode(weatherSel.value);
    weatherSel.addEventListener('change', applyWeather);

    const biomeSel = document.getElementById('biomeSel');
    const applyBiome = ()=> { BiomeManager.setBiome(biomeSel.value); applyWeather(); };
    biomeSel.addEventListener('change', applyBiome);
    applyBiome();

    const clock = new THREE.Clock();
    let isNight = false;
    function loop(){
      const dt = clock.getDelta();
      const t = clock.elapsedTime;
      controls.update();
      const nightNow = updateDayNight(dt);
      if (nightNow !== isNight){ isNight = nightNow; BiomeManager.setDayNight(isNight); }
      weather.update(t, camera);
      if (fauna) fauna.update(dt);
      if (ambient) ambient.update(dt);
      const rainMix = weather._mix?.rain || 0;
      const snowMix = weather._mix?.snow || 0;
      const heightFactor = Math.max(0.2, 1 - 0.3 * rainMix - 0.6 * snowMix);
      grassMesh.material.uniforms.heightFactor.value = heightFactor;
      grassMesh.material.uniforms.snowMix.value = snowMix;

      const windMix = Math.max(weather._mix?.wind || 0, weather._mix?.sand || 0);
      const wind = weather.wind || { x: 1, z: 0 };
      const len = Math.hypot(wind.x, wind.z) || 1;
      grassMesh.material.uniforms.windDirection.value.set(wind.x / len, wind.z / len);
      grassMesh.material.uniforms.windStrength.value = 0.2 + 3.0 * windMix;
      if (ambient) {
        for (const sys of ambient.systems) {
          const mat = sys.mesh.material;
          if (mat && mat.uniforms) {
            mat.uniforms.snowMix.value = snowMix;
            mat.uniforms.windDirection.value.set(wind.x / len, wind.z / len);
            mat.uniforms.windStrength.value = 0.2 + 3.0 * windMix;
          }
        }
      }

      skyMat.uniforms.time.value = t;
      renderer.render(scene, camera);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
